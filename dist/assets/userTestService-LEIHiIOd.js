import{J as z,a as G,r,x as i,O as b,Q as H,K as q}from"./index-D9eu1wvy.js";import{u as D,T as M,g as L,d as V,c as I,q as R,w as U,a as W,l as C,o as P,b as Q,s as X}from"./firestore-CkCHjU9t.js";const $=z("userTestService",()=>{const{db:g}=D(),{user:a}=G();let w;const m=r(),c=r();let l=new Map;const x=r(!0),p=r(180),_=r(""),S=r(""),T=r(),h=r(),d=r();let y=null;const N=25;async function F(){a.value&&await b(a.value,{displayName:_.value})}async function A(){a.value&&await Promise.all([b(a.value,{displayName:_.value}),H(a.value,S.value)])}async function B(s){const{get:u}=q(),e=await u("/test",{testId:s,displayName:_.value,email:S.value});if(c.value=e.test,w=e.userTestId,c.value&&(p.value=c.value.time_limit,p.value>0)){let t=setInterval(()=>{p.value--,p.value===0&&(clearInterval(t),t=void 0)},1e3);return t}}async function E(s){var n,o;const{post:u}=q();l=new Map,w&&l.set("user_test_id",[w]),(n=c.value)!=null&&n.id&&l.set("test_id",[c.value.id]);for(const[v,f]of s)f.toString()!==""&&(l.has(v)?(o=l.get(v))==null||o.push(f.toString()):l.set(v,[f.toString()]));const e=Object.fromEntries(l),t=await u("/finish-test",e);return t.started_at=M.fromMillis(t.started_at._seconds*1e3),t.ended_in=M.fromMillis(t.ended_in._seconds*1e3),t}function O(s){m.value=s}async function j(s){const{db:u}=D();if(!m.value){const e=await L(V(u,"user_tests",s));e.exists()&&(m.value=e.data(),m.value.id=e.id)}}async function J(){var t,n,o;if(T.value===((t=a.value)==null?void 0:t.uid)&&h.value!==void 0)return;T.value=(n=a.value)==null?void 0:n.uid;const s=I(g,"user_tests"),u=R(s,U("test.user_id","==",(o=a.value)==null?void 0:o.uid)),e=await W(u);h.value=e.data().count}async function K(){var t,n,o;if(T.value===((t=a.value)==null?void 0:t.uid)&&d.value)return;T.value=(n=a.value)==null?void 0:n.uid;const s=I(g,"user_tests"),u=R(s,U("test.user_id","==",(o=a.value)==null?void 0:o.uid),P("started_at","desc"),C(N)),e=await Q(u);d.value=e.docs.map(v=>{const f=v.data();return f.id=v.id,f}),y=e.docs.length===0?null:e.docs[e.docs.length-1]}async function k(){if(!d.value||!y)return;const s=I(g,"user_tests"),u=R(s,U("test.user_id","==",T.value),P("started_at","desc"),X(y),C(N)),e=await Q(u),t=e.docs.map(n=>{const o=n.data();return o.id=n.id,o});y=e.docs.length===0?null:e.docs[e.docs.length-1],d.value=d.value.concat(t)}return{requestUserInfo:i(()=>x),displayName:i(()=>_),email:i(()=>S),test:i(()=>c),time_limit:i(()=>p),testReport:i(()=>m),userTestCount:i(()=>h),userTests:i(()=>d),updateUserInfo:A,updateDisplayName:F,initTest:B,sendReport:E,setTestReport:O,initTestReport:j,loadUserTestCount:J,loadUserTests:K,loadMoreUserTests:k}});export{$ as u};
