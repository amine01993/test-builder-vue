import{M as J,a as I,r as o,x as r,N as b,O as K,Q as q}from"./index-B1zD-M5g.js";import{u as D,T as C,g as L,d as V,c as R,q as U,w as N,a as W,l as P,o as Q,b as x,s as X}from"./firestore-qVOR4QEO.js";const $=J("userTestService",()=>{const{db:g}=D(),{user:l}=I();let w;const m=o(),c=o();let i=new Map;const F=o(!0),p=o(180),_=o(""),S=o(""),T=o(),h=o(),d=o();let y=null;const M=25;async function A(){const{user:e}=I();e.value&&await b(e.value,{displayName:_.value})}async function E(){const{user:e}=I();e.value&&await Promise.all([b(e.value,{displayName:_.value}),K(e.value,S.value)])}async function O(e){const{get:a}=q(),t=await a("/test",{testId:e,displayName:_.value,email:S.value});if(c.value=t.test,w=t.userTestId,c.value&&(p.value=c.value.time_limit,p.value>0)){let s=setInterval(()=>{p.value--,p.value===0&&(clearInterval(s),s=void 0)},1e3);return s}}async function j(e){var u,n;const{post:a}=q();i=new Map,w&&i.set("user_test_id",[w]),(u=c.value)!=null&&u.id&&i.set("test_id",[c.value.id]);for(const[v,f]of e)f.toString()!==""&&(i.has(v)?(n=i.get(v))==null||n.push(f.toString()):i.set(v,[f.toString()]));const t=Object.fromEntries(i),s=await a("/finish-test",t);return s.started_at=C.fromMillis(s.started_at._seconds*1e3),s.ended_in=C.fromMillis(s.ended_in._seconds*1e3),s}function B(e){m.value=e}async function k(e){const{db:a}=D();if(!m.value){const t=await L(V(a,"user_tests",e));t.exists()&&(m.value=t.data(),m.value.id=t.id)}}async function z(){var s,u,n;if(T.value===((s=l.value)==null?void 0:s.uid)&&h.value!==void 0)return;T.value=(u=l.value)==null?void 0:u.uid;const e=R(g,"user_tests"),a=U(e,N("test.user_id","==",(n=l.value)==null?void 0:n.uid)),t=await W(a);h.value=t.data().count}async function G(){var s,u,n;if(T.value===((s=l.value)==null?void 0:s.uid)&&d.value)return;T.value=(u=l.value)==null?void 0:u.uid;const e=R(g,"user_tests"),a=U(e,N("test.user_id","==",(n=l.value)==null?void 0:n.uid),Q("started_at","desc"),P(M)),t=await x(a);d.value=t.docs.map(v=>{const f=v.data();return f.id=v.id,f}),y=t.docs.length===0?null:t.docs[t.docs.length-1]}async function H(){if(!d.value||!y)return;const e=R(g,"user_tests"),a=U(e,N("test.user_id","==",T.value),Q("started_at","desc"),X(y),P(M)),t=await x(a),s=t.docs.map(u=>{const n=u.data();return n.id=u.id,n});y=t.docs.length===0?null:t.docs[t.docs.length-1],d.value=d.value.concat(s)}return{requestUserInfo:r(()=>F),displayName:r(()=>_),email:r(()=>S),test:r(()=>c),time_limit:r(()=>p),testReport:r(()=>m),userTestCount:r(()=>h),userTests:r(()=>d),updateUserInfo:E,updateDisplayName:A,initTest:O,sendReport:j,setTestReport:B,initTestReport:k,loadUserTestCount:z,loadUserTests:G,loadMoreUserTests:H}});export{$ as u};
