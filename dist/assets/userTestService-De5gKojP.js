import{J as z,a as I,r,x as o,K as b,L as G,M as q}from"./index-CEw6Ur-o.js";import{u as D,T as C,g as H,d as V,c as R,q as U,w as M,a as W,l as P,o as x,b as F,s as X}from"./firestore-O8Pw084e.js";const $=z("userTestService",()=>{const{db:g}=D(),{user:l}=I();let w,m=r(),c=r(),i=new Map;const Q=r(!0),p=r(180),_=r(""),S=r(""),T=r(),h=r(),d=r();let y=null;const N=25;async function A(){const{user:e}=I();e.value&&await b(e.value,{displayName:_.value})}async function E(){const{user:e}=I();e.value&&await Promise.all([b(e.value,{displayName:_.value}),G(e.value,S.value)])}async function j(e){const{get:a}=q(),t=await a("/test",{testId:e,displayName:_.value,email:S.value});if(c.value=t.test,w=t.userTestId,c.value&&(p.value=c.value.time_limit,p.value>0)){let s=setInterval(()=>{p.value--,p.value===0&&(clearInterval(s),s=void 0)},1e3);return s}}async function B(e){var u,n;const{post:a}=q();i=new Map,w&&i.set("user_test_id",[w]),(u=c.value)!=null&&u.id&&i.set("test_id",[c.value.id]);for(const[v,f]of e)f.toString()!==""&&(i.has(v)?(n=i.get(v))==null||n.push(f.toString()):i.set(v,[f.toString()]));const t=Object.fromEntries(i),s=await a("/finish-test",t);return s.started_at=C.fromMillis(s.started_at._seconds*1e3),s.ended_in=C.fromMillis(s.ended_in._seconds*1e3),s}function J(e){m.value=e}async function K(e){const{db:a}=D();if(!m.value){const t=await H(V(a,"user_tests",e));t.exists()&&(m.value=t.data(),m.value.id=t.id)}}async function L(){var s,u,n;if(T.value===((s=l.value)==null?void 0:s.uid)&&h.value!==void 0)return;T.value=(u=l.value)==null?void 0:u.uid;const e=R(g,"user_tests"),a=U(e,M("test.user_id","==",(n=l.value)==null?void 0:n.uid)),t=await W(a);h.value=t.data().count}async function O(){var s,u,n;if(T.value===((s=l.value)==null?void 0:s.uid)&&d.value)return;T.value=(u=l.value)==null?void 0:u.uid;const e=R(g,"user_tests"),a=U(e,M("test.user_id","==",(n=l.value)==null?void 0:n.uid),x("started_at","desc"),P(N)),t=await F(a);d.value=t.docs.map(v=>{const f=v.data();return f.id=v.id,f}),y=t.docs.length===0?null:t.docs[t.docs.length-1]}async function k(){if(!d.value||!y)return;const e=R(g,"user_tests"),a=U(e,M("test.user_id","==",T.value),x("started_at","desc"),X(y),P(N)),t=await F(a),s=t.docs.map(u=>{const n=u.data();return n.id=u.id,n});y=t.docs.length===0?null:t.docs[t.docs.length-1],d.value=d.value.concat(s)}return{requestUserInfo:o(()=>Q),displayName:o(()=>_),email:o(()=>S),test:o(()=>c),time_limit:o(()=>p),testReport:o(()=>m),userTestCount:o(()=>h),userTests:o(()=>d),updateUserInfo:E,updateDisplayName:A,initTest:j,sendReport:B,setTestReport:J,initTestReport:K,loadUserTestCount:L,loadUserTests:O,loadMoreUserTests:k}});export{$ as u};
