import{G as E,u as R,r as c,c as d,H as N,I as L}from"./index-CGS4B7OT.js";import{u as P,T as q,g as G,d as J,c as D,q as S,w as I,a as K,l as M,o as j,b as A,s as V}from"./firestore-B39V3hTY.js";const C=E("fetch",()=>{const h="http://127.0.0.1:5001/test-builder-api/us-central1/api";async function v(){var o;const{user:s}=R(),u=new Headers;u.append("Content-Type","application/json");const a=await((o=s.value)==null?void 0:o.getIdToken(!1));return a&&u.append("Authorization",a),u}async function f(s,u={}){const a=new URLSearchParams(u);let o=h+s;a.size>0&&(o+="?"+a.toString());const m=await v();return(await fetch(o,{headers:m})).json()}async function l(s,u={}){const a=h+s,o=await v();return(await fetch(a,{headers:o,method:"POST",body:JSON.stringify(u)})).json()}return{get:f,post:l}}),Y=E("userTestService",()=>{const{db:h}=P();let v,f=c(),l=c(),s=new Map;const u=c(!0),a=c(180),o=c(""),m=c(""),g=c(),U=c(),w=c();let _=null;const b=25;async function F(){const{user:e}=R();e.value&&await N(e.value,{displayName:o.value})}async function H(){const{user:e}=R();e.value&&await Promise.all([N(e.value,{displayName:o.value}),L(e.value,m.value)])}async function O(e){const{get:r}=C(),t=await r("/test",{testId:e,displayName:o.value,email:m.value});if(l.value=t.test,v=t.userTestId,l.value&&(a.value=l.value.time_limit,a.value>0)){let n=setInterval(()=>{a.value--,a.value===0&&(clearInterval(n),n=void 0)},1e3);return n}}async function Q(e){var p,i;const{post:r}=C();s=new Map,v&&s.set("user_test_id",[v]),(p=l.value)!=null&&p.id&&s.set("test_id",[l.value.id]);for(const[y,T]of e)T.toString()!==""&&(s.has(y)?(i=s.get(y))==null||i.push(T.toString()):s.set(y,[T.toString()]));const t=Object.fromEntries(s),n=await r("/finish-test",t);return n.started_at=q.fromMillis(n.started_at._seconds*1e3),n.ended_in=q.fromMillis(n.ended_in._seconds*1e3),n}function k(e){f.value=e}async function x(e){const{db:r}=P();if(!f.value){const t=await G(J(r,"user_tests",e));t.exists()&&(f.value=t.data(),f.value.id=t.id)}}async function z(e){if(g.value===e)return;g.value=e;const r=D(h,"user_tests"),t=S(r,I("test.user_id","==",e)),n=await K(t);U.value=n.data().count;const p=S(r,I("test.user_id","==",e),j("started_at","desc"),M(b)),i=await A(p);w.value=i.docs.map(y=>{const T=y.data();return T.id=y.id,T}),_=i.docs.length===0?null:i.docs[i.docs.length-1]}async function B(){if(!w.value||!_)return;const e=D(h,"user_tests"),r=S(e,I("test.user_id","==",g.value),j("started_at","desc"),V(_),M(b)),t=await A(r),n=t.docs.map(p=>{const i=p.data();return i.id=p.id,i});_=t.docs.length===0?null:t.docs[t.docs.length-1],w.value=w.value.concat(n)}return{requestUserInfo:d(()=>u),displayName:d(()=>o),email:d(()=>m),test:d(()=>l),time_limit:d(()=>a),testReport:d(()=>f),userTestCount:d(()=>U),userTests:d(()=>w),updateUserInfo:H,updateDisplayName:F,initTest:O,sendReport:Q,setTestReport:k,initTestReport:x,loadUserTests:z,loadMoreUserTests:B}});export{Y as u};
